{% extends "base.html" %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400 mb-1">{{ t("history_label", lang) }}</p>
        <h1 class="text-2xl font-semibold">{{ t("history_title", lang) }}</h1>
        <p class="text-slate-400 text-sm">{{ t("history_subtitle", lang) }}</p>
    </div>
    <div class="flex items-center gap-2">
        <a href="/history?lang={{ lang }}&format=csv{% if selected_task %}&task={{ selected_task }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if preset %}&preset={{ preset }}{% endif %}" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition border border-white/5 text-sm">{{ t("export_csv", lang) }}</a>
    </div>
</div>

<div class="space-y-3 mb-4">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
        <input type="hidden" name="lang" value="{{ lang }}">
        <select name="task" class="bg-slate-900 border border-white/5 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
            <option value="">{{ t("all_tasks", lang) }}</option>
            {% for t in tasks %}
            <option value="{{ t.slug }}" {% if selected_task == t.slug %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
        </select>
        <input type="date" name="start_date" value="{{ start_date }}" class="bg-slate-900 border border-white/5 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="{{ t('start_date', lang) }}">
        <input type="date" name="end_date" value="{{ end_date }}" class="bg-slate-900 border border-white/5 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="{{ t('end_date', lang) }}">
        <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-emerald-500/90 hover:bg-emerald-500 text-slate-950 font-semibold px-3 py-2 rounded-xl transition shadow-lg shadow-emerald-500/20">{{ t("filters_apply", lang) }}</button>
            <a href="/history?lang={{ lang }}" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition border border-white/5">{{ t("filters_reset", lang) }}</a>
        </div>
    </form>
    <div class="flex flex-wrap gap-2 text-xs">
        <span class="text-slate-400">{{ t("quick_ranges", lang) }}:</span>
        {% for code, label in [("today", t("range_today", lang)), ("7d", t("range_7d", lang)), ("30d", t("range_30d", lang))] %}
        <a href="/history?lang={{ lang }}&preset={{ code }}" class="px-3 py-1.5 rounded-full border border-white/10 hover:border-white/20 {{ 'bg-white/10 text-slate-100' if preset==code else 'text-slate-400' }}">{{ label }}</a>
        {% endfor %}
    </div>
    {% set active = [] %}
    {% if selected_task %}{% set _ = active.append({"key":"task","label":t("filter_task", lang) ~ ": " ~ selected_task}) %}{% endif %}
    {% if start_date %}{% set _ = active.append({"key":"start_date","label":t("filter_start", lang) ~ ": " ~ start_date}) %}{% endif %}
    {% if end_date %}{% set _ = active.append({"key":"end_date","label":t("filter_end", lang) ~ ": " ~ end_date}) %}{% endif %}
    {% if preset %}
        {% set preset_label = t("range_today", lang) if preset=="today" else (t("range_7d", lang) if preset=="7d" else t("range_30d", lang)) %}
        {% set _ = active.append({"key":"preset","label":t("filter_preset", lang) ~ ": " ~ preset_label}) %}
    {% endif %}
    {% if active %}
    <div class="flex flex-wrap gap-2 items-center text-xs">
        <span class="text-slate-400">{{ t("applied_filters", lang) }}</span>
        {% for item in active %}
        <form method="get" class="inline-flex">
            <input type="hidden" name="lang" value="{{ lang }}">
            {% if item.key != "task" and selected_task %}<input type="hidden" name="task" value="{{ selected_task }}">{% endif %}
            {% if item.key != "start_date" and start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
            {% if item.key != "end_date" and end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
            {% if item.key != "preset" and preset %}<input type="hidden" name="preset" value="{{ preset }}">{% endif %}
            <button type="submit" class="px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 flex items-center gap-1">
                <span>{{ item.label }}</span>
                <span aria-hidden="true">‚úï</span>
            </button>
        </form>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="space-y-3">
    {% for ev in events %}
    {% set task = task_map.get(ev.task_type_id) %}
    {% set state = recency_state(ev.timestamp) %}
    {% set state_class = "border-emerald-400/30 bg-emerald-500/5" if state=="fresh" else ("border-amber-400/30 bg-amber-500/5" if state=="warm" else "border-white/5 bg-slate-900/70") %}
    <div class="{{ state_class }} rounded-2xl p-3 flex items-center gap-3 shadow-lg shadow-black/40">
        <div class="h-12 w-12 rounded-2xl bg-slate-800 flex items-center justify-center text-xl">{{ task.icon if task else "üêæ" }}</div>
        <div class="flex-1">
            <p class="font-semibold">{{ task.name if task else t("unknown_task", lang) }}</p>
            <p class="text-slate-400 text-sm">{{ ev.note or t("no_note", lang) }}</p>
        </div>
        <div class="text-right text-sm">
            <p class="text-slate-200">{{ humanize(ev.timestamp, lang) }}</p>
            <p class="text-slate-500">{{ ev.who or t("anonymous", lang) }} ¬∑ {{ ev.source or "web" }}</p>
        </div>
        <form method="post" action="/history/{{ ev.id }}/delete?lang={{ lang }}{% if selected_task %}&task={{ selected_task }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if preset %}&preset={{ preset }}{% endif %}{% if page %}&page={{ page }}{% endif %}" class="self-start">
            <input type="hidden" name="csrf_token" value="{{ request.session.get('csrf_token') }}">
            <button type="submit" data-confirm="{{ t('delete_confirm', lang) }}" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-red-500/20 border border-white/10 text-xs text-slate-200">
                {{ t("delete_entry", lang) }}
            </button>
        </form>
    </div>
    {% else %}
    <div class="text-slate-400 text-sm">{{ t("history_empty", lang) }}</div>
    {% endfor %}
</div>

{% set total_pages = (total_count + per_page - 1) // per_page %}
{% if total_pages > 1 %}
<div class="mt-6 flex items-center justify-between text-sm">
    <form method="get" class="flex items-center gap-2">
        <input type="hidden" name="lang" value="{{ lang }}">
        {% if selected_task %}<input type="hidden" name="task" value="{{ selected_task }}">{% endif %}
        {% if start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
        {% if end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
        {% if preset %}<input type="hidden" name="preset" value="{{ preset }}">{% endif %}
        <input type="hidden" name="page" value="{{ page - 1 }}">
        <button type="submit" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 disabled:opacity-40" {% if page <= 1 %}disabled{% endif %}>{{ t("prev_page", lang) }}</button>
    </form>
    <span class="text-slate-400">{{ t("page_label", lang) }} {{ page }} / {{ total_pages }}</span>
    <form method="get" class="flex items-center gap-2">
        <input type="hidden" name="lang" value="{{ lang }}">
        {% if selected_task %}<input type="hidden" name="task" value="{{ selected_task }}">{% endif %}
        {% if start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
        {% if end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
        {% if preset %}<input type="hidden" name="preset" value="{{ preset }}">{% endif %}
        <input type="hidden" name="page" value="{{ page + 1 }}">
        <button type="submit" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 disabled:opacity-40" {% if page >= total_pages %}disabled{% endif %}>{{ t("next_page", lang) }}</button>
    </form>
</div>
{% endif %}
{% endblock %}
